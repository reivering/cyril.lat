<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYRIL'S ADVENTURE | Game Portfolio</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #0aff00;
            --neon-gold: #ffd700;
            --bg-color: #050505;
            --ui-bg: rgba(0, 0, 15, 0.95);
            --border: 4px solid #fff;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: 'VT323', monospace;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            touch-action: none; /* Prevents mobile scrolling/zooming */
        }

        /* --- CRT SCANLINE EFFECT --- */
        #crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* --- GAME CANVAS --- */
        canvas {
            display: block;
            image-rendering: pixelated; /* Essential for retro look */
        }

        /* --- UI OVERLAYS --- */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            z-index: 10;
        }

        /* Start Screen */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: auto;
        }
        
        h1 {
            font-family: 'Press Start 2P', cursive;
            color: var(--neon-blue);
            text-shadow: 4px 4px var(--neon-pink);
            font-size: clamp(20px, 5vw, 60px);
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
            animation: pulse 2s infinite;
        }

        .btn {
            font-family: 'Press Start 2P', cursive;
            background: transparent;
            color: white;
            border: 4px solid white;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            box-shadow: 0 0 15px var(--neon-blue);
        }
        .btn:hover { background: white; color: black; box-shadow: 0 0 30px var(--neon-blue); }

        /* Dialog Box */
        #dialog-box {
            position: absolute;
            bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 800px;
            background: var(--ui-bg);
            border: 4px solid white;
            padding: 20px;
            display: none;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        #dialog-text {
            font-size: 24px;
            line-height: 1.2;
            margin-bottom: 10px;
        }
        #dialog-hint {
            font-size: 16px; color: var(--neon-green); text-align: right; animation: blink 1s infinite;
        }

        /* Mobile Controls */
        #controls {
            position: absolute;
            bottom: max(20px, env(safe-area-inset-bottom)); 
            left: max(20px, env(safe-area-inset-left)); 
            right: max(20px, env(safe-area-inset-right));
            height: 150px;
            display: none; /* Shown via JS on touch devices */
            pointer-events: none;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 50;
        }
        .d-pad {
            width: 120px; height: 120px;
            position: relative;
            pointer-events: auto;
        }
        .d-btn {
            position: absolute;
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 5px;
        }
        .d-btn:active { background: rgba(255,255,255,0.6); }
        .d-up { top: 0; left: 40px; }
        .d-down { bottom: 0; left: 40px; }
        .d-left { top: 40px; left: 0; }
        .d-right { top: 40px; right: 0; }

        .action-btn {
            width: 80px; height: 80px;
            background: rgba(255, 0, 0, 0.3);
            border: 4px solid rgba(255, 0, 0, 0.6);
            border-radius: 50%;
            pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Press Start 2P'; font-size: 24px;
            margin-bottom: 20px;
        }
        .action-btn:active { background: rgba(255,0,0,0.6); }

        /* Inventory / Menu */
        #inventory {
            position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 600px;
            max-height: 80vh; /* Prevent overflow on small screens */
            overflow-y: auto;
            background: #222;
            border: 4px solid var(--neon-blue);
            padding: 20px;
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            z-index: 100;
            pointer-events: auto;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.8);
        }
        .inv-item {
            width: 100px; height: 100px;
            background: #111;
            border: 2px solid #555;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .inv-item:hover { border-color: var(--neon-green); transform: scale(1.05); }
        .inv-icon { font-size: 30px; margin-bottom: 5px; }
        .inv-name { font-size: 14px; text-align: center; }

        /* Save Point / Contact Form */
        #contact-form-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center; align-items: center;
            z-index: 200;
            pointer-events: auto;
        }
        .save-menu {
            background: var(--neon-blue);
            padding: 4px;
            width: 90%; max-width: 500px;
            animation: slideUp 0.3s ease-out;
        }
        .save-inner {
            background: #000;
            padding: 20px;
            border: 4px solid white;
        }
        .save-title { font-family: 'Press Start 2P'; text-align: center; margin-bottom: 20px; color: var(--neon-green); }
        input, textarea {
            width: 100%;
            background: #111; border: 2px solid #333;
            color: white; font-family: 'VT323'; font-size: 20px;
            padding: 10px; margin-bottom: 10px;
        }
        .close-btn { position: absolute; top: 20px; right: 20px; color: white; cursor: pointer; font-family: 'Press Start 2P'; }

        /* --- ORACLE CHAT (LLM) --- */
        #oracle-ui {
            position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 600px;
            background: var(--ui-bg);
            border: 4px double var(--neon-gold);
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 15px;
            z-index: 300;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
            pointer-events: auto;
        }
        .oracle-header {
            font-family: 'Press Start 2P';
            color: var(--neon-gold);
            text-align: center;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .oracle-response-area {
            height: 150px;
            background: #111;
            border: 2px solid #444;
            padding: 10px;
            overflow-y: auto;
            font-size: 20px;
            color: #ddd;
            font-family: 'VT323';
        }
        .oracle-input-area {
            display: flex;
            gap: 10px;
        }
        #oracle-input {
            flex-grow: 1;
            background: #000;
            border: 2px solid var(--neon-gold);
            color: white;
            font-family: 'VT323';
            font-size: 20px;
            padding: 10px;
        }
        #oracle-btn {
            background: var(--neon-gold);
            color: black;
            font-family: 'Press Start 2P';
            border: none;
            cursor: pointer;
            padding: 0 15px;
            font-size: 14px;
        }
        #oracle-btn:hover { background: #fff; }
        .oracle-close {
            text-align: center; color: #888; cursor: pointer; margin-top: 5px; font-size: 14px;
        }

        /* Animations */
        @keyframes pulse { 0%, 100% { opacity: 1; text-shadow: 4px 4px var(--neon-pink); } 50% { opacity: 0.8; text-shadow: 2px 2px var(--neon-blue); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Top HUD */
        #hud {
            display: flex; justify-content: space-between; width: 100%; pointer-events: none;
        }
        .hud-item {
            font-family: 'Press Start 2P'; font-size: 12px;
            background: rgba(0,0,0,0.7); padding: 10px; border: 2px solid white;
            pointer-events: auto; cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- CRT Overlay -->
    <div id="crt-overlay"></div>

    <!-- Start Screen -->
    <div id="start-screen">
        <h1>CYRIL'S<br>ODYSSEY</h1>
        <p style="font-size: 24px; color: #aaa; margin-bottom: 40px;">PRESS START TO BEGIN</p>
        <button class="btn" onclick="startGame()">START GAME</button>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- UI Layers -->
    <div class="ui-layer">
        <div id="hud">
            <div class="hud-item" onclick="toggleInventory()">[I] SKILLS</div>
            <div class="hud-item" style="color:var(--neon-green)">LOC: <span id="loc-name">BEDROOM</span></div>
        </div>

        <div id="controls">
            <div class="d-pad">
                <div class="d-btn d-up" id="btn-up"></div>
                <div class="d-btn d-down" id="btn-down"></div>
                <div class="d-btn d-left" id="btn-left"></div>
                <div class="d-btn d-right" id="btn-right"></div>
            </div>
            <div class="action-btn" id="btn-action">A</div>
        </div>
    </div>

    <!-- Dialog Box -->
    <div id="dialog-box">
        <div id="dialog-text">Text goes here...</div>
        <div id="dialog-hint">PRESS [SPACE] TO CONTINUE</div>
    </div>

    <!-- Inventory / Skills -->
    <div id="inventory">
        <h2 style="width: 100%; text-align: center; font-family: 'Press Start 2P'; color: var(--neon-blue); margin-bottom: 20px;">INVENTORY (SKILLS)</h2>
        <div class="inv-item">
            <div class="inv-icon">‚ö°</div>
            <div class="inv-name">JavaScript</div>
        </div>
        <div class="inv-item">
            <div class="inv-icon">‚öõÔ∏è</div>
            <div class="inv-name">React</div>
        </div>
        <div class="inv-item">
            <div class="inv-icon">üêç</div>
            <div class="inv-name">Python</div>
        </div>
        <div class="inv-item">
            <div class="inv-icon">üé®</div>
            <div class="inv-name">CSS3</div>
        </div>
        <div class="inv-item">
            <div class="inv-icon">üíæ</div>
            <div class="inv-name">SQL</div>
        </div>
        <div class="inv-item">
            <div class="inv-icon">üõ†Ô∏è</div>
            <div class="inv-name">Git</div>
        </div>
        <div style="width: 100%; text-align: center; margin-top: 10px; color: #888;">(CLICK TO CLOSE)</div>
    </div>

    <!-- Oracle UI (Gemini Integration) -->
    <div id="oracle-ui">
        <div class="oracle-header">‚ú® THE ORACLE ‚ú®</div>
        <div class="oracle-response-area" id="oracle-response">
            GREETINGS, TRAVELER. I AM CONNECTED TO THE ETHER (GEMINI AI). ASK ME OF CYRIL'S LEGEND OR THE WAYS OF CODE.
        </div>
        <div class="oracle-input-area">
            <input type="text" id="oracle-input" placeholder="Ask a question..." onkeydown="if(event.key==='Enter') callGemini()">
            <button id="oracle-btn" onclick="callGemini()">ASK ‚ú®</button>
        </div>
        <div class="oracle-close" onclick="closeOracle()">[ CLOSE COMM LINK ]</div>
    </div>

    <!-- Save Point / Contact -->
    <div id="contact-form-container">
        <div class="close-btn" onclick="closeContact()">X</div>
        <div class="save-menu">
            <div class="save-inner">
                <div class="save-title">SAVE YOUR PROGRESS?</div>
                <p style="text-align: center; color: #aaa; margin-bottom: 20px;">(Send me a message)</p>
                <form onsubmit="event.preventDefault(); alert('Message sent to the void (demo)!'); closeContact();">
                    <input type="text" placeholder="PLAYER NAME">
                    <input type="email" placeholder="EMAIL FREQUENCY">
                    <textarea rows="4" placeholder="MESSAGE DATA..."></textarea>
                    <button class="btn" style="width: 100%; margin-top: 10px;">SAVE (SEND)</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- GAME ENGINE & LOGIC ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game State
        let gameRunning = false;
        let lastTime = 0;
        let currentRoom = 'bedroom'; // bedroom, city, boss, shrine
        
        // Input State
        const keys = { w: false, a: false, s: false, d: false, space: false, enter: false };
        
        // Constants
        const TILE_SIZE = 48;
        const SPEED = 4;
        
        // Entities
        const player = {
            x: 0, y: 0, w: 32, h: 32,
            color: '#00f3ff',
            direction: 'down',
            frame: 0,
            moving: false
        };

        const rooms = {
            bedroom: {
                width: 600, height: 400,
                color: '#1a1a1a',
                objects: [
                    { id: 'bed', x: 50, y: 50, w: 80, h: 120, color: '#ff5555', type: 'interact', label: 'SLEEP (EXIT)', msg: "Returning to main menu..." },
                    { id: 'desk', x: 400, y: 50, w: 150, h: 80, color: '#8b4513', type: 'interact', label: 'WORKSTATION', msg: "My Projects Portal. Press [SPACE] to enter." },
                    { id: 'door', x: 270, y: 350, w: 60, h: 50, color: '#333', type: 'portal', target: 'city', spawnX: 100, spawnY: 300, label: 'EXIT' },
                    { id: 'shelf', x: 50, y: 200, w: 50, h: 100, color: '#654321', type: 'interact', label: 'BOOKS', msg: "I'm Cyril, a Full Stack Web Dev & Data Analyst.<br>Studying at Sunway University.<br>Graduating Jan 2027." }
                ],
                spawn: { x: 300, y: 200 }
            },
            city: {
                width: 1200, height: 800,
                color: '#0a0a1a',
                objects: [
                    // Buildings (Projects)
                    { id: 'proj1', x: 100, y: 100, w: 200, h: 150, color: '#333', type: 'interact', label: 'POKEMON (JAVA)', msg: "OOP Project: A Pokemon game built with Java. Press [SPACE] to view code." },
                    { id: 'proj2', x: 400, y: 100, w: 200, h: 150, color: '#444', type: 'interact', label: 'SQL ANALYTICS', msg: "Database Project: Complex SQL queries and data management. Press [SPACE]." },
                    { id: 'proj3', x: 700, y: 100, w: 200, h: 150, color: '#555', type: 'interact', label: 'FOOD DIST APP', msg: "Food Distribution App: Managing logistics. Press [SPACE] to view." },
                    // Path to other rooms
                    { id: 'home', x: 50, y: 300, w: 50, h: 100, color: '#222', type: 'portal', target: 'bedroom', spawnX: 270, spawnY: 300, label: 'HOME' },
                    { id: 'boss_gate', x: 1000, y: 300, w: 100, h: 150, color: '#500', type: 'portal', target: 'boss', spawnX: 100, spawnY: 300, label: 'BOSS ZONE' },
                    { id: 'shrine_gate', x: 500, y: 600, w: 100, h: 100, color: '#005', type: 'portal', target: 'shrine', spawnX: 300, spawnY: 450, label: 'SHRINE' },
                    // THE ORACLE NPC
                    { id: 'oracle', x: 600, y: 400, w: 60, h: 60, color: '#ffd700', type: 'interact', label: 'THE ORACLE', msg: "AI INTERFACE ONLINE." }
                ],
                spawn: { x: 150, y: 400 }
            },
            boss: {
                width: 800, height: 600,
                color: '#200',
                objects: [
                    { id: 'boss', x: 300, y: 100, w: 200, h: 200, color: '#f00', type: 'interact', label: 'THE CAPSTONE', msg: "BOSS: 'I am the SaaS Platform! I have 99% Uptime!' (It's a really big project)." },
                    { id: 'exit', x: 350, y: 500, w: 100, h: 50, color: '#444', type: 'portal', target: 'city', spawnX: 950, spawnY: 350, label: 'ESCAPE' }
                ],
                spawn: { x: 400, y: 450 }
            },
            shrine: {
                width: 600, height: 600,
                color: '#001',
                objects: [
                    { id: 'crystal', x: 250, y: 250, w: 100, h: 100, color: '#0ff', type: 'interact', label: 'SAVE POINT', msg: "Opening Contact Link..." },
                    { id: 'exit', x: 250, y: 500, w: 100, h: 50, color: '#444', type: 'portal', target: 'city', spawnX: 550, spawnY: 550, label: 'EXIT' }
                ],
                spawn: { x: 300, y: 450 }
            }
        };

        // --- GEMINI API INTEGRATION ---
        const apiKey = "AIzaSyDS8Lpzvjkd0-KDJD6GtznnH6lsnlCZWu0"; 

        async function callGemini() {
            const inputField = document.getElementById('oracle-input');
            const responseArea = document.getElementById('oracle-response');
            const userQuery = inputField.value.trim();

            if (!userQuery) return;

            // UI State: Loading
            responseArea.innerHTML += `<br><span style="color:var(--neon-green)">> YOU: ${userQuery}</span>`;
            responseArea.innerHTML += `<br><span style="color:#888">...THINKING...</span>`;
            responseArea.scrollTop = responseArea.scrollHeight;
            inputField.value = '';

            try {
                if (!apiKey) {
                    throw new Error("API Key is missing. Please edit index.html and add your Gemini API Key.");
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: "You are The Oracle, an ancient digital entity in a pixel art RPG portfolio. Answer questions about web development, Cyril's skills (JS, React, Python), and technology in a wise, cryptic, but helpful way. Use video game metaphors. Keep it short." }] }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "The signal is weak... try again.";

                // Remove 'Thinking' and add response
                responseArea.innerHTML = responseArea.innerHTML.replace('<br><span style="color:#888">...THINKING...</span>', '');
                responseArea.innerHTML += `<br><span style="color:var(--neon-gold)">> ORACLE:</span> ${reply}<br>`;
                responseArea.scrollTop = responseArea.scrollHeight;

            } catch (error) {
                console.error(error); // Log full error to console
                // Remove 'Thinking' text
                responseArea.innerHTML = responseArea.innerHTML.replace('<br><span style="color:#888">...THINKING...</span>', '');
                // Show specific error message
                responseArea.innerHTML += `<br><span style="color:red">ERROR: ${error.message}</span>`;
            }
        }

        function closeOracle() {
            document.getElementById('oracle-ui').style.display = 'none';
            gameRunning = true;
            requestAnimationFrame(gameLoop);
        }

        // --- AUDIO SYNTHESIS (Retro SFX) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const actx = new AudioContext();
        
        function playTone(freq, type, duration) {
            if (actx.state === 'suspended') actx.resume();
            const osc = actx.createOscillator();
            const gain = actx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, actx.currentTime);
            gain.gain.setValueAtTime(0.1, actx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + duration);
            osc.connect(gain);
            gain.connect(actx.destination);
            osc.start();
            osc.stop(actx.currentTime + duration);
        }

        function sfxWalk() { playTone(100 + Math.random()*50, 'square', 0.05); }
        function sfxSelect() { playTone(600, 'square', 0.1); playTone(800, 'square', 0.1); }
        function sfxBump() { playTone(150, 'sawtooth', 0.1); }

        // --- INITIALIZATION ---
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            // Show mobile controls if on mobile
            if ('ontouchstart' in window || navigator.maxTouchPoints) {
                document.getElementById('controls').style.display = 'flex';
            }
            
            // Set spawn
            const room = rooms[currentRoom];
            player.x = room.spawn.x;
            player.y = room.spawn.y;
            
            gameRunning = true;
            sfxSelect();
            requestAnimationFrame(gameLoop);
        }

        // --- INPUT HANDLERS ---
        window.addEventListener('keydown', e => {
            if(e.key === 'ArrowUp' || e.key === 'w') keys.w = true;
            if(e.key === 'ArrowDown' || e.key === 's') keys.s = true;
            if(e.key === 'ArrowLeft' || e.key === 'a') keys.a = true;
            if(e.key === 'ArrowRight' || e.key === 'd') keys.d = true;
            if(e.key === ' ' || e.key === 'Enter') handleInteraction();
            if(e.key === 'i') toggleInventory();
        });

        window.addEventListener('keyup', e => {
            if(e.key === 'ArrowUp' || e.key === 'w') keys.w = false;
            if(e.key === 'ArrowDown' || e.key === 's') keys.s = false;
            if(e.key === 'ArrowLeft' || e.key === 'a') keys.a = false;
            if(e.key === 'ArrowRight' || e.key === 'd') keys.d = false;
        });

        // Touch Controls
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnAct = document.getElementById('btn-action');

        const addTouch = (elem, key) => {
            elem.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            elem.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
        };
        addTouch(btnUp, 'w'); addTouch(btnDown, 's'); addTouch(btnLeft, 'a'); addTouch(btnRight, 'd');
        btnAct.addEventListener('touchstart', (e) => { e.preventDefault(); handleInteraction(); });

        // --- INTERACTION ---
        let dialogOpen = false;
        
        function handleInteraction() {
            if (dialogOpen) {
                document.getElementById('dialog-box').style.display = 'none';
                dialogOpen = false;
                return;
            }

            const room = rooms[currentRoom];
            // Simple proximity check
            const cx = player.x + player.w/2;
            const cy = player.y + player.h/2;

            let hit = room.objects.find(obj => {
                // EXPANDED INTERACTION ZONE: Allow access from all sides (Top, Bottom, Left, Right)
                const interactionMargin = 40; 
                return cx > obj.x - interactionMargin && 
                       cx < obj.x + obj.w + interactionMargin && 
                       cy > obj.y - interactionMargin && 
                       cy < obj.y + obj.h + interactionMargin;
            });

            if (hit) {
                if (hit.type === 'interact') {
                    if (hit.id === 'oracle') {
                        // Open Gemini Chat
                        document.getElementById('oracle-ui').style.display = 'flex';
                        gameRunning = false;
                        sfxSelect();
                    } else if (hit.id === 'desk') {
                        // Link Workstation to GitHub
                        showDialog(hit.label, "CONNECTING TO GITHUB...");
                        setTimeout(() => window.open('https://github.com/reivering?tab=repositories', '_blank'), 1000);
                    } else if (hit.id === 'bed') {
                        // Return to Main Menu
                        showDialog(hit.label, "GOING TO SLEEP...");
                        setTimeout(() => {
                            document.getElementById('dialog-box').style.display = 'none';
                            document.getElementById('start-screen').style.display = 'flex';
                            gameRunning = false;
                        }, 1500);
                    } else if (hit.id === 'proj1') {
                        // Link Project A (Pokemon)
                        showDialog(hit.label, "OPENING POKEMON REPO...");
                        setTimeout(() => window.open('https://github.com/reivering/pokemon', '_blank'), 1000);
                    } else if (hit.id === 'proj2') {
                        // Link Project B (SQL)
                        showDialog(hit.label, "OPENING SQL REPO...");
                        setTimeout(() => window.open('https://github.com/reivering/sql-project', '_blank'), 1000);
                    } else if (hit.id === 'proj3') {
                        // Link Project C (Food Distribution)
                        showDialog(hit.label, "OPENING FOOD APP REPO...");
                        setTimeout(() => window.open('https://github.com/reivering/food-distribution', '_blank'), 1000);
                    } else {
                        showDialog(hit.label, hit.msg);
                        if (hit.id === 'crystal') {
                            setTimeout(() => document.getElementById('contact-form-container').style.display = 'flex', 500);
                        }
                    }
                } else if (hit.type === 'portal') {
                    loadRoom(hit.target, hit.spawnX, hit.spawnY);
                }
            }
        }

        function showDialog(title, text) {
            sfxSelect();
            const box = document.getElementById('dialog-box');
            document.getElementById('dialog-text').innerHTML = `<strong style="color:var(--neon-blue)">${title}</strong><br>${text}`;
            box.style.display = 'block';
            dialogOpen = true;
        }

        function loadRoom(targetRoom, x, y) {
            sfxSelect();
            currentRoom = targetRoom;
            player.x = x;
            player.y = y;
            document.getElementById('loc-name').innerText = currentRoom.toUpperCase();
        }

        // --- UPDATE LOOP ---
        function update() {
            if (dialogOpen) return;

            const room = rooms[currentRoom];
            let dx = 0; let dy = 0;

            if (keys.w) dy = -SPEED;
            if (keys.s) dy = SPEED;
            if (keys.a) dx = -SPEED;
            if (keys.d) dx = SPEED;

            // Normalize diagonal
            if (dx !== 0 && dy !== 0) { dx *= 0.707; dy *= 0.707; }

            // Move & Collide
            let nextX = player.x + dx;
            let nextY = player.y + dy;
            
            // Bounds check
            if (nextX < 0) nextX = 0;
            if (nextY < 0) nextY = 0;
            if (nextX > room.width - player.w) nextX = room.width - player.w;
            if (nextY > room.height - player.h) nextY = room.height - player.h;

            // Object collision (solid)
            let collide = false;
            room.objects.forEach(obj => {
                if (obj.type === 'solid' || obj.type === 'interact') { // Treat interactables as solid
                    if (nextX < obj.x + obj.w && nextX + player.w > obj.x &&
                        nextY < obj.y + obj.h && nextY + player.h > obj.y) {
                        collide = true;
                    }
                }
            });

            if (!collide) {
                player.x = nextX;
                player.y = nextY;
                if (dx !== 0 || dy !== 0) {
                    player.moving = true;
                    if (Math.random() < 0.1) sfxWalk(); // Occasional step sound
                } else {
                    player.moving = false;
                }
            } else {
                player.moving = false;
            }
        }

        // --- RENDER LOOP ---
        function draw() {
            // Clear screen
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const room = rooms[currentRoom];

            // Camera Logic (Center player)
            let camX = player.x - canvas.width / 2 + player.w / 2;
            let camY = player.y - canvas.height / 2 + player.h / 2;
            
            // Clamp camera to room bounds
            /* If room is smaller than screen, center room. 
               If larger, clamp. 
            */
            if (room.width < canvas.width) camX = -(canvas.width - room.width)/2;
            else {
                if (camX < 0) camX = 0;
                if (camX > room.width - canvas.width) camX = room.width - canvas.width;
            }

            if (room.height < canvas.height) camY = -(canvas.height - room.height)/2;
            else {
                if (camY < 0) camY = 0;
                if (camY > room.height - canvas.height) camY = room.height - canvas.height;
            }

            ctx.save();
            ctx.translate(-camX, -camY);

            // Draw Room Background
            ctx.fillStyle = room.color;
            ctx.fillRect(0, 0, room.width, room.height);
            
            // Grid lines for retro feel
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 2;
            for(let x=0; x<room.width; x+=TILE_SIZE) {
                ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x, room.height); ctx.stroke();
            }
            for(let y=0; y<room.height; y+=TILE_SIZE) {
                ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(room.width, y); ctx.stroke();
            }

            // Draw Objects
            room.objects.forEach(obj => {
                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(obj.x + 5, obj.y + obj.h - 5, obj.w, 10);

                // Body
                ctx.fillStyle = obj.color;
                ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                
                // Outline/Highlight
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);

                // Label floating above
                if (obj.label) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '16px "Press Start 2P"';
                    ctx.textAlign = 'center';
                    // ctx.fillText(obj.label, obj.x + obj.w/2, obj.y - 10); // Cluttered
                }
                
                // Specific Detail Drawing (Procedural Art)
                if (obj.id === 'bed') {
                    ctx.fillStyle = '#fff'; ctx.fillRect(obj.x+5, obj.y+5, obj.w-10, 30); // Pillow
                }
                if (obj.id.includes('proj')) {
                    // Windows
                    ctx.fillStyle = '#ff0'; 
                    if(Math.random() > 0.95) ctx.fillStyle = '#000'; // Flicker
                    ctx.fillRect(obj.x + 20, obj.y + 40, 30, 30);
                    ctx.fillRect(obj.x + 80, obj.y + 40, 30, 30);
                }
                if (obj.id === 'crystal') {
                    // Glow
                    const glow = Math.abs(Math.sin(Date.now() / 500)) * 20;
                    ctx.shadowBlur = glow + 10;
                    ctx.shadowColor = '#0ff';
                    ctx.fillStyle = '#e0ffff';
                    ctx.beginPath();
                    ctx.moveTo(obj.x + obj.w/2, obj.y);
                    ctx.lineTo(obj.x + obj.w, obj.y + obj.h/2);
                    ctx.lineTo(obj.x + obj.w/2, obj.y + obj.h);
                    ctx.lineTo(obj.x, obj.y + obj.h/2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
                // ORACLE VISUALS
                if (obj.id === 'oracle') {
                    // Floating Animation
                    const float = Math.sin(Date.now() / 300) * 5;
                    ctx.fillStyle = '#000'; // Eyes
                    ctx.fillRect(obj.x + 10, obj.y + 15 + float, 10, 5);
                    ctx.fillRect(obj.x + 40, obj.y + 15 + float, 10, 5);
                    // Aura
                    ctx.shadowBlur = 20; ctx.shadowColor = '#ffd700';
                    ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2;
                    ctx.strokeRect(obj.x, obj.y + float, obj.w, obj.h);
                    ctx.shadowBlur = 0;
                }
            });

            // Draw Player
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(player.x + 4, player.y + player.h - 4, player.w - 8, 8);
            
            // Body
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.w, player.h);
            
            // Face (Eyes blink)
            ctx.fillStyle = '#000';
            if (Date.now() % 3000 < 100) {
                 ctx.fillRect(player.x + 6, player.y + 8, 20, 2); // Blink
            } else {
                ctx.fillRect(player.x + 6, player.y + 8, 6, 6); // Left Eye
                ctx.fillRect(player.x + 20, player.y + 8, 6, 6); // Right Eye
            }
            
            // Interaction Prompt Helper
            // Find nearby object and draw arrow
            const cx = player.x + player.w/2;
            const cy = player.y + player.h/2;
            let near = room.objects.find(obj => {
                // Match the logic in handleInteraction so the arrow appears when interaction is possible
                const interactionMargin = 40;
                return cx > obj.x - interactionMargin && 
                       cx < obj.x + obj.w + interactionMargin && 
                       cy > obj.y - interactionMargin && 
                       cy < obj.y + obj.h + interactionMargin;
            });
            if (near) {
                const bounce = Math.sin(Date.now() / 200) * 5;
                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('‚ñº', near.x + near.w/2, near.y - 20 + bounce);
                ctx.font = '10px "Press Start 2P"';
                ctx.fillText(near.label, near.x + near.w/2, near.y - 40 + bounce);
            }

            ctx.restore();
        }

        function gameLoop(timestamp) {
            if (!gameRunning) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // --- UI FUNCTIONS ---
        function toggleInventory() {
            const inv = document.getElementById('inventory');
            if (inv.style.display === 'flex') {
                inv.style.display = 'none';
                gameRunning = true;
                requestAnimationFrame(gameLoop);
            } else {
                inv.style.display = 'flex';
                gameRunning = false; // Pause game logic
                sfxSelect();
            }
        }

        document.getElementById('inventory').addEventListener('click', toggleInventory);

        function closeContact() {
            document.getElementById('contact-form-container').style.display = 'none';
        }

    </script>
</body>
</html>
